# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  # Use the custom EndeavourOS box
  config.vm.box = "endeavouros"

  # Set up VM properties
  config.vm.provider "virtualbox" do |vb|
    vb.memory = "8192"
    vb.cpus = 2
    
    # Enable 3D acceleration
    vb.customize ["modifyvm", :id, "--accelerate3d", "on"]
    vb.customize ["modifyvm", :id, "--graphicscontroller", "vmsvga"]
    vb.customize ["modifyvm", :id, "--vram", "128"]
  end

  # Disable default synced folder (optional)
  #config.vm.synced_folder "C:/08-Repos/VagrantSyncFolder", "/home/vagrant", type: "virtualbox"

  # Provision the VM with a shell script, run as the 'vagrant' user
  config.vm.provision "shell", inline: <<-SHELL
    # Update system
    sudo pacman -Syu --noconfirm

    # Install necessary packages
    # sudo pacman -S git base-devel mesa --noconfirm

    # Run the following commands as the 'vagrant' user
    sudo -u vagrant bash <<EOF
      # Clone the repository
      git clone https://github.com/Anarcho/dev-machine.git /home/vagrant/dev-machine

      # Navigate to the cloned repository
      cd /home/vagrant/dev-machine

      # Make setup.sh and update_config.sh executable
      chmod +x setup.sh update_config.sh

      # Run the setup and config update scripts
      ./setup.sh
      ./update_config.sh
    EOF

    # Enable 3D acceleration in X11 configuration
    echo 'Section "Device"
    Identifier  "Card0"
    Driver      "vmware"
    Option      "AccelMethod"    "glamor"
EndSection' | sudo tee /etc/X11/xorg.conf.d/20-vmware.conf

    # Reboot the system to apply changes
    sudo reboot
  SHELL
end
